version: 2.1

# Reusable commands
commands:
  package_and_checksum:
    description: "Package built binary into tar.gz and generate sha256"
    parameters:
      crate_name:
        type: string
      target:
        type: string
      out_name:
        type: string
    steps:
      - run:
          name: Package << parameters.out_name >>
          command: |
            set -euxo pipefail
            CRATE="<< parameters.crate_name >>"
            TARGET="<< parameters.target >>"
            OUT="<< parameters.out_name >>"

            BIN="target/${TARGET}/release/${CRATE}"
            test -f "$BIN" || (echo "Binary not found: $BIN" && exit 1)

            mkdir -p release stage
            cp "$BIN" "stage/${CRATE}"
            chmod +x "stage/${CRATE}"

            tar -C stage -czf "release/${OUT}.tar.gz" "${CRATE}"
            (cd release && shasum -a 256 "${OUT}.tar.gz" > "${OUT}.tar.gz.sha256")
            rm -rf stage
      - persist_to_workspace:
          root: .
          paths:
            - release

jobs:
  build-linux:
    docker:
      - image: cimg/rust:stable
    environment:
      CRATE_NAME: pet
      TARGET: x86_64-unknown-linux-gnu
      OUT_NAME: pet-linux-x86_64
    steps:
      - checkout
      - run:
          name: Add target
          command: rustup target add "$TARGET"
      - run:
          name: Build (Linux)
          command: cargo build --release --target "$TARGET"
      - package_and_checksum:
          crate_name: pet
          target: x86_64-unknown-linux-gnu
          out_name: pet-linux-x86_64

  build-macos:
    macos:
      xcode: "15.4.0"   # any modern image is fine; we only use it to get a macOS runner
    environment:
      CRATE_NAME: pet
      TARGET: x86_64-apple-darwin
      OUT_NAME: pet-macos-x86_64
      RUSTUP_HOME: /Users/distiller/.rustup
      CARGO_HOME: /Users/distiller/.cargo
      # NOTE: Circle macOS images have Homebrew; we install rustup toolchain ourselves.
    steps:
      - checkout
      - run:
          name: Install Rust (rustup)
          command: |
            set -euxo pipefail
            if ! command -v rustup >/dev/null; then
              curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
              echo 'export PATH="$HOME/.cargo/bin:$PATH"' >> $BASH_ENV
            fi
            source $BASH_ENV
            rustup default stable
            rustup target add "$TARGET"
      - run:
          name: Build (macOS)
          command: |
            source $BASH_ENV
            cargo build --release --target "$TARGET"
      - package_and_checksum:
          crate_name: pet
          target: x86_64-apple-darwin
          out_name: pet-macos-x86_64

  publish-release:
    docker:
      - image: cimg/base:stable
    environment:
      GH_TOKEN: ${GITHUB_TOKEN}   # set in CircleCI project settings
    steps:
      - checkout
      - attach_workspace:
          at: .
      - run:
          name: Install GitHub CLI
          command: |
            set -euxo pipefail
            type -p gh >/dev/null || (
              curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
              sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
              echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
              sudo apt-get update -y
              sudo apt-get install -y gh
            )
      - run:
          name: Create (if missing) and upload assets to GitHub Release
          command: |
            set -euxo pipefail
            TAG="${CIRCLE_TAG}"
            test -n "$TAG"

            # Ensure we are acting on the right repo (owner/name)
            REPO="$(git config --get remote.origin.url | sed -E 's#.*github.com[:/](.+)\.git#\1#')"

            # Create release if not exists
            if ! gh release view "$TAG" --repo "$REPO" >/dev/null 2>&1; then
              gh release create "$TAG" --repo "$REPO" -t "$TAG" -n "Release $TAG"
            fi

            # Upload all artifacts from both build jobs
            gh release upload "$TAG" release/* --clobber --repo "$REPO"

workflows:
  version: 2
  release-on-tag:
    when: on_success
    jobs:
      - build-linux:
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^v\d+\.\d+\.\d+(-\S+)?$/
      - build-macos:
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^v\d+\.\d+\.\d+(-\S+)?$/
      - publish-release:
          requires:
            - build-linux
            - build-macos
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^v\d+\.\d+\.\d+(-\S+)?$/
