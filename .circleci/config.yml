version: 2.1

commands:
  package_and_checksum:
    description: "Package built binary into tar.gz and generate sha256"
    parameters:
      crate_name: { type: string }
      target: { type: string }
      out_name: { type: string }
    steps:
      - run:
          name: Package << parameters.out_name >>
          command: |
            set -euxo pipefail
            CRATE="<< parameters.crate_name >>"
            TARGET="<< parameters.target >>"
            OUT="<< parameters.out_name >>"
            BIN="target/${TARGET}/release/${CRATE}"
            test -f "$BIN" || (echo "Binary not found: $BIN" && exit 1)
            mkdir -p release stage
            cp "$BIN" "stage/${CRATE}"
            chmod +x "stage/${CRATE}"
            tar -C stage -czf "release/${OUT}.tar.gz" "${CRATE}"
            (cd release && shasum -a 256 "${OUT}.tar.gz" > "${OUT}.tar.gz.sha256")
            rm -rf stage

jobs:
  build-linux:
    docker:
      - image: cimg/rust:1.91.0
    environment:
      CRATE_NAME: pet
      TARGET: x86_64-unknown-linux-gnu
      OUT_NAME: pet-linux-x86_64
    steps:
      - checkout
      - run: rustup target add "$TARGET"
      - run: cargo build --release --target "$TARGET"
      - package_and_checksum:
          crate_name: pet
          target: x86_64-unknown-linux-gnu
          out_name: pet-linux-x86_64
      - persist_to_workspace:
          root: .
          paths: [release]

  build-macos:
    macos:
      xcode: "15.4.0"
    environment:
      CRATE_NAME: pet
      TARGET: x86_64-apple-darwin
      OUT_NAME: pet-macos-x86_64
      RUSTUP_HOME: /Users/distiller/.rustup
      CARGO_HOME: /Users/distiller/.cargo
    steps:
      - checkout
      - run:
          name: Install Rust (rustup)
          command: |
            set -euxo pipefail
            if ! command -v rustup >/dev/null; then
              curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
              echo 'export PATH="$HOME/.cargo/bin:$PATH"' >> $BASH_ENV
            fi
            source $BASH_ENV
            rustup default stable
            rustup target add "$TARGET"
      - run:
          name: Build (macOS)
          command: |
            source $BASH_ENV
            cargo build --release --target "$TARGET"
      - package_and_checksum:
          crate_name: pet
          target: x86_64-apple-darwin
          out_name: pet-macos-x86_64
      - persist_to_workspace:
          root: .
          paths: [release]

  publish-release:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - attach_workspace: { at: . }
      - run:
          name: Sanity check token
          command: |
            set -euo pipefail
            : "${CIRCLE_TAG:?CIRCLE_TAG not set}"
            : "${GITHUB_TOKEN:?GITHUB_TOKEN not set}"   # fails fast if project var missing
            # show only presence/length (CircleCI may mask value)
            echo "GITHUB_TOKEN present; length=${#GITHUB_TOKEN}"
      - run:
          name: Create/Update GitHub Release and upload assets (REST API)
          command: |
            set -euo pipefail
            REPO_SLUG="rishabhpoddar/bitpet-cli"
            TAG="${CIRCLE_TAG}"

            # prove GitHub accepts it (Bearer first, then token fallback)
            curl -sSf -H "Authorization: Bearer ${GITHUB_TOKEN}" https://api.github.com/user >/dev/null \
              || curl -sSf -H "Authorization: token ${GITHUB_TOKEN}" https://api.github.com/user >/dev/null

            # get or create release
            if ! curl -fsS -H "Authorization: Bearer ${GITHUB_TOKEN}" \
                  "https://api.github.com/repos/${REPO_SLUG}/releases/tags/${TAG}" \
                  -o release.json; then
              curl -fsS -X POST -H "Authorization: Bearer ${GITHUB_TOKEN}" \
                -H "Content-Type: application/json" \
                -d "{\"tag_name\":\"${TAG}\",\"name\":\"${TAG}\",\"body\":\"Release ${TAG}\"}" \
                "https://api.github.com/repos/${REPO_SLUG}/releases" \
                -o release.json
            fi

            RELEASE_ID=$(jq -r '.id' < release.json)
            test "$RELEASE_ID" != "null" -a -n "$RELEASE_ID"

            # upload assets
            for f in release/*; do
              [ -f "$f" ] || continue
              NAME=$(basename "$f")
              echo "Uploading $NAME"
              curl -fsS -X POST \
                -H "Authorization: Bearer ${GITHUB_TOKEN}" \
                -H "Content-Type: application/octet-stream" \
                --data-binary @"$f" \
                "https://uploads.github.com/repos/${REPO_SLUG}/releases/${RELEASE_ID}/assets?name=${NAME}" \
                >/dev/null
            done

workflows:
  version: 2
  release-on-tag:
    jobs:
      - build-linux:
          filters:
            branches: { ignore: /.*/ }
            tags: { only: /.*/ }
      - build-macos:
          filters:
            branches: { ignore: /.*/ }
            tags: { only: /.*/ }
      - publish-release:
          requires: [build-linux, build-macos]
          filters:
            branches: { ignore: /.*/ }
            tags: { only: /.*/ }
